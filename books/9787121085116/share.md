
这里总结了《程序员的自我修养——链接、转载与库》、《链接器和加载器》的主要内容，包括ELF文件格式、静态链接、动态链接、程序的加载、动态库等（基于Linux平台），不包括Windows平台的知识点。显然，这是一份大纲，更加详细的内容，还请异步阅读原书。

对比两本书，其实内容差不多。就相关知识的全面性而言，《自我修养》稍微欠缺，《链接器和加载器》更为全面。但是《自我修养》比较容易上手阅读，知识递进很有层次，比较容易理解。《链接器和加载器》的内容跳转很大，章与章之间没有层次（可能是我太菜，无法理解）。比如前两章，第一章 链接和加载，第二章 体系结构的问题，直接把我整懵逼了，说的都是啥啊。个人建议先阅读《自我修养》，然后再阅读《链接器和加载器》，这样比较容易理解。

祭上书籍封面：

![程序员的自我修养](pic/程序员的自我修养.jpg)

![链接器和加载器](pic/链接器和加载器.jpg)

电子版下载链接：https://share.pkemb.com/books/

## 程序生命周期

先来看看程序的生命周期，往后会按顺序依次介绍各个知识点。所以此图务必牢记。

![](pic/程序生命周期.png)

## 编译

* 词法分析
* 语法分析
* 中间代码生成
* 中间代码优化
* 目标代码生成

[](pic/compilation.png)

## ELF文件格式

介绍可重定位文件和共享目标文件常见的段及其含义，以及如何用命令查看。最好有一个例子。最后引出符号的概念。

### 目标文件包含的内容
* 头信息
* 目标代码
* 重定位信息
* 符号
* 调试信息

### 目标文件格式类别
* 空目标文件格式：MS-DOS的COM文件
* 代码区段：UNIX的a.out文件
* 重定位：MS-DOS的EXE文件
* 可重定位的a.out格式
* UNIX的ELF格式
* IBM 360目标格式
* 微软PE格式
* Intel/Microsoft的OMF文件格式

### ELF 文件格式

ELF将文件分为4类。

| 类型 | 链接 | 加载 | 说明 |
| - | - | - | - | - |
| 可重定位文件 | Y | N | 由编译器和汇编器创建，运行前需要被链接器处理。 |
| 可执行文件 | N | Y | 完成了所有的重定位工作和符号解析（除共享库符号）。 |
| 共享目标文件 | Y | Y | 即包括链接器需要的符号信息，也包括运行时可以直接执行的代码。 |
| 核心转储文件 | - | - | - |

![](pic/ELF的链接和执行视图.png)

#### ELF 文件头

readelf -h objfile.o

| 字段      | 说明 |
| --------- | ---- |
| e_ident   |      |
| e_type    |      |
| e_machine |      |
| e_version |      |
| e_entry   |      |
| e_phoff   |      |
| e_shoff   |      |
|  e_flags ||
| e_ehsize ||
|  ||
|  ||
|  ||
|  ||
|  ||
|  ||

#### 可重定位文件

可重定位文件可以看作是一系列在区段头部表（Section header table）中被定义的区段的集合。

readelf -S objfile.o

* 区段头部表字段
* 常见区段类型
* 常见区段

#### ELF可执行文件

程序头部定义了要被映射的段。

readelf -l execfile

* 程序头部表字段
* 常见的段类型



## (静态)链接和重定位

对于链接器而言，链接的整个过程将多个输入目标文件加工合并成一个输出文件。对于静态链接而言，主要过程分为两步：

1. 空间与地址分配：相似段合并，分配空间，收集符号定义和引用，构建全局符号表。
2. 符号解析与重定位：读取输入文件中段的数据、重定位信息，并且进行符号解析与重定位、调整代码中的地址等。

### 空间与地址分配

![](pic/链接空间分配.png)

#### 符号地址的确定

链接完成之后，各个段的虚拟地址已经确定了。而符号在段内的偏移是固定的，从而可以确定符号的地址。

### 符号解析和重定位

### 链接过程控制

### 链接的其他细节

* 弱符号和强符号
* 重复代码消除
* 全局构造和析构
* ABI



两遍链接

目标代码库

重定位和代码修改



链接器的主要工作有：

1. 重定位：重新计算各个符号的地址的过程
2. 库查询
3. 符号管理
4. 地址绑定

## 动态链接

### 为什么需要动态链接？

### 地址无关代码

### 延迟绑定

### 动态链接的数据结构

### 动态链接的步骤

### 显示动态链接

## 库

* 静态库
* 静态共享库
* 动态共享库

## 加载